<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width">
    <title>RGYB surgery success prediction tool</title>
    <link rel="stylesheet" href="{{ url_for('static',filename='css/style.css')}}">
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
</head>   
<body>
    <div id="navbarToggleExternalContent">
        <div class="bg-dark p-4">
            <div class="row">
                <div class="col">
                    <img class="encabezadol" src="{{ url_for('static',filename='/images/unav-white-logo.svg')}}" alt="unav Logo" class="img-fluid" >
                </div>
                <div class="col">
                    <img class="encabezadol" src="{{ url_for('static',filename='/images/logo-blanco-cun.svg')}}" alt="unav clinic Logo" class="img-fluid" >
                </div>
                <div class="col">
                    <img class="encabezado2" src="{{ url_for('static',filename='/images/tecnun2.png')}}" alt="tecnun" class="img-fluid" >
                </div>
            </div>
        </div>
    </div>
    <h1 style="text-align: center;">RGYB surgery success prediction tool</h1> 
    <div class="container">
        <div class="row align-items-start">
            <div class="col">
                <div class="card">
                    <h2>Introduction</h2> 
                    <p>
                        This tool was developed as a joint effort of the Metabolic Research Laboratory, Cl√≠nica Universidad de Navarra and Tecnun School of Engineering,
                        Universidad de Navarra, to help healthcare professionals in the estimation of the likelihood of Roux-en-Y bariatric surgery success based on 
                        patient-specific pre and perioperative data (see below for the needed input variables).

                        By leveraging three Machine Learning (ML) models to choose from, this tool provides success/failure predictions along with probability success score. These models
                        have been trained using surgery outcome at 18 months measured by the following two metrics:
                    </p>
                    <div class="accordion" id="accordionPanelsStayOpenExample">
                        <div class="accordion-item">
                          <h2 class="accordion-header" id="headingOne">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#panelsStayOpen-collapseOne" aria-expanded="true" aria-controls="panelsStayOpen-collapseOne">
                                Body Mass Index (BMI)
                                <i class="bi bi-chevron-compact-down"></i>
                            </button>
                          </h2>
                          <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="panelsStayOpen-headingOne">
                            <div class="accordion-body">
                                Prediction based on Body Mass Index (BMI) metric, computed as weight in kilograms divided by the square of height in meters. A BMI <strong>equal to or less</strong> than <strong>30 kg/m2</strong>
                                is <strong>considered success</strong> (ML models based on BMI are referred to as <i>Model 1 & Model 2</i>).

                            </div>
                          </div>
                        </div>
                        <div class="accordion-item">
                          <h2 class="accordion-header" id="headingTwo">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#panelsStayOpen-collapseTwo" aria-expanded="false" aria-controls="panelsStayOpen-collapseTwo">
                                Excess Weight Loss (EWL)
                                <i class="bi bi-chevron-compact-down"></i>
                            </button>
                          </h2>
                          <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="panelsStayOpen-headingTwo">
                            <div class="accordion-body">
                                Prediction based on Excess Weight Loss (EWL) metric, calculated according to the formula EWL = (body weight (BW) before ‚Äì BW after)/excess BW before, 
                                where excess BW = total BW ‚Äì ideal BW. An EWL% <strong> equal or greater </strong> than <strong>65% for males </strong> and <strong>75% for females </strong> is <strong>considered success</strong> (ML model based on EWL is referred to as <i>Model 3</i>).

                            </div>
                          </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card" style="width: 18rem;">
                <img src="{{ url_for('static',filename='/images/foto_equipo.JPG')}}" class="card-img-top" alt="Research group">
                <div class="card-body">
                    <h5 class="card-title">Research Team</h5>
                    <p class="card-text">members of the research group from left to right</p>
                    <ul class="list-group">
                        <li class="list-group-item">Dra. Idoia Ochoa √Ålvarez</li>
                        <li class="list-group-item">Rocio Mar√∫gan Pinos</li>
                        <li class="list-group-item">Dr. Javier G√≥mez Ambrosi</li>
                        <li class="list-group-item"> Dra. Gema Fr√ºhbeck</li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="row align-items-center">
            <div class="col">
                <div class="card">
                        <h2>How it works</h2>
                        <p>
                            <strong>1.</strong>&nbsp; Upload a CSV file containing patient data.
                            ML models <i>Model 1 & Model 2</i>, based on BMI, need as input 16 variables (see provided test_data_1_2.csv file in GitHub for an example). ML model <i>Model 3</i>, based on EWL, needs as input 58 variables (see provided test_data_3.csv file in GitHub for an example).
                        </p>
                        <p>
                            <strong>2.</strong>&nbsp; The tool expects a .csv file following the structure of the provided examples. In the first case, predictions for Model 1 and Model 2 will be computed; whereas in the second case only predictions for Model 3 will be computed.
                            In all cases, the models will analyze the input and predict the probability of treatment success.
                        </p>        
                        <p><strong>3.</strong>&nbsp; Results of the predictions will be added as new columns in a newly generated .csv (one per model run), including:
                            <ul class="indentted">
                                <li>
                                    Computed probability of success.
                                </li>
                                <li>
                                    Final predicted label: 1 for ‚Äúsuccess‚Äù and 0 for ‚Äúfailure‚Äù.
                                </li>
                                <li>
                                    Final writen label: ‚Äúsuccess‚Äù or ‚Äúfailure‚Äù.
                                </li>
                            </ul>
                        </p> 
                        <p>    
                            <strong>Important note:&nbsp;</strong>Variables <strong>‚ÄúRoux Limb‚Äù</strong> and <strong>‚ÄúTreitz‚Äù</strong> are perioperative anatomical landmarks, that is, 
                            defined during the surgery. Please enter in your .csv file whichever value you would like
                            to evaluate for each individual patient, taking into account that a higher value means a more aggressive surgery. In particular:
                            <ul class="indented">
                                <li>
                                    Roux Limb (alimentary limb): part of the small intestine that bypasses the stomach and duodenum. It connects
                                    the gastric pouch with the anastomosis with the biliopancreatic limb to allow contact between food and digestive enzymes.
                                    Value usually ranges from 40 to 400 cm.
                                </li>
                                <li>
                                    Treitz: part of the jejunum bypassed until the point of biliopancreatic limb anastomosis. Value usually ranges from 30 to 170 cm.
                                </li>
                            </ul>
                        </p>               
                </div>
            </div>
            <div class="col d-flex justify-content-center">
                <div class="card" style="width: 24rem;">     
                    <p>
                        <strong>üìÇ Upload your file to get started!</strong>
                    </p>
                    <form  id="uploadForm" enctype="multipart/form-data"> 
                        <img src="{{ url_for('static',filename='/images/subir-archivo.gif')}}" class="card-img-top" alt="...">
                        <input type="file" name="archivo" accept=".csv">
                        <input type="submit" value="Upload">
                        <h1 id="charged"></h1>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var collapseOne = document.getElementById('collapseOne');
            var collapseTwo = document.getElementById('collapseTwo');

            var bsCollapseOne = new bootstrap.Collapse(collapseOne, {
                toggle: true // Mostrar inicialmente si est√° configurado para ello
            });

            var bsCollapseTwo = new bootstrap.Collapse(collapseTwo, {
                toggle: false // No mostrar inicialmente
            });

            var buttonOne = document.querySelector('#headingOne .accordion-button');
            var buttonTwo = document.querySelector('#headingTwo .accordion-button');

            buttonOne.addEventListener('click', function () {
                bsCollapseOne.toggle(); // Alterna el primer colapso
                toggleIcon(this);
            });

            buttonTwo.addEventListener('click', function () {
                bsCollapseTwo.toggle(); // Alterna el segundo colapso
                toggleIcon(this);
            });

            
            function toggleIcon(button) {
                    console.log('Button clicked');
                    var icon = button.querySelector('i');
                    if (icon.classList[1]=='bi-chevron-compact-down') {
                        icon.classList.remove('bi-chevron-compact-down');
                        icon.classList.add('bi-chevron-compact-up');
                    } else {
                        icon.classList.remove('bi-chevron-compact-up');
                        icon.classList.add('bi-chevron-compact-down');
                    }
            };
        });
        document.addEventListener("DOMContentLoaded", function() {
            // Manejador de evento para el formulario
            const form = document.getElementById("uploadForm");
            form.addEventListener("submit", function(event) {
                event.preventDefault(); // Prevenir el env√≠o por defecto

                const formData = new FormData(form);

                fetch("/", {
                    method: "POST",
                    body: formData
                })
                .then(response => response.text()) // Obtener el texto de la respuesta
                .then(text => {
                    // Actualizar el contenido del h1 con id "charged"
                    document.getElementById("charged").innerText = text;
                })
                .catch(error => {
                    document.getElementById("charged").innerText = "Error al enviar el formulario: " + error.message;
                });
            });
        })
    </script>
</body>
</html>